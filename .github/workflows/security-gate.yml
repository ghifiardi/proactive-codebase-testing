name: Security Gate

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  security-gate:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Analyze changed files
      id: analyze
      run: |
        # Get changed files
        git diff --name-only origin/${{ github.base_ref }}...HEAD > changed_files.txt
        
        # Analyze changed files
        python -m src.cli.main analyze . \
          --format json \
          --output pr-analysis.json \
          --severity high
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      continue-on-error: true
    
    - name: Check for critical findings
      id: check
      run: |
        if [ -f pr-analysis.json ]; then
          CRITICAL_COUNT=$(python -c "import json; data=json.load(open('pr-analysis.json')); print(sum(1 for f in data.get('findings', []) if f.get('severity') == 'critical'))")
          echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$CRITICAL_COUNT" -gt 0 ]; then
            echo "‚ùå Found $CRITICAL_COUNT critical security issues"
            exit 1
          else
            echo "‚úÖ No critical security issues found"
          fi
        fi
    
    - name: Comment PR with results
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          let comment = '## üîç Security Analysis Results\n\n';
          
          if (fs.existsSync('pr-analysis.json')) {
            const data = JSON.parse(fs.readFileSync('pr-analysis.json', 'utf8'));
            const summary = data.summary || {};
            
            comment += `- **Total Findings:** ${summary.total_findings || 0}\n`;
            comment += `- **Critical:** ${summary.findings_by_severity?.critical || 0}\n`;
            comment += `- **High:** ${summary.findings_by_severity?.high || 0}\n`;
            comment += `- **Medium:** ${summary.findings_by_severity?.medium || 0}\n\n`;
            
            if (summary.total_findings > 0) {
              comment += '‚ö†Ô∏è Please review the findings before merging.\n';
            } else {
              comment += '‚úÖ No security issues detected!\n';
            }
          } else {
            comment += '‚ö†Ô∏è Analysis could not be completed.\n';
          }
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

